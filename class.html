<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ç­ç´šç§©åºç®¡ç†ç³»çµ±</title>
    <style>
        :root { --primary: #4a90e2; --green: #2ecc71; --yellow: #f1c40f; --red: #e74c3c; --bg: #f8f9fa; }
        body { font-family: "Microsoft JhengHei", sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; }
        #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { padding: 30px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); text-align: center; }
        input[type="password"] { padding: 10px; font-size: 18px; border: 2px solid #ddd; border-radius: 5px; margin-bottom: 10px; }
        .tabs { margin-bottom: 20px; display: flex; flex-wrap: wrap; justify-content: center; }
        .tab-btn { padding: 12px 25px; font-size: 18px; cursor: pointer; border: none; background: #ddd; margin: 5px; border-radius: 8px; transition: 0.3s; }
        .tab-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(74,144,226,0.3); }
        .class-panel { background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 450px; text-align: center; display: none; }
        .class-panel.active { display: block; }
        .timer { font-size: 60px; font-weight: bold; color: #333; margin: 15px 0; font-family: monospace; }
        .score-display { font-size: 22px; margin-bottom: 25px; color: #555; background: #f0f7ff; padding: 10px; border-radius: 10px; }
        .traffic-light { display: flex; justify-content: space-around; background: #333; padding: 25px; border-radius: 25px; }
        .light { width: 90px; height: 90px; border-radius: 50%; cursor: pointer; opacity: 0.2; transition: 0.2s; border: 4px solid rgba(255,255,255,0.1); }
        .green { background-color: var(--green); }
        .yellow { background-color: var(--yellow); }
        .red { background-color: var(--red); }
        .light.active { opacity: 1; box-shadow: 0 0 30px currentColor; }
        .btn-group button { padding: 8px 18px; cursor: pointer; margin: 5px; border-radius: 5px; border: 1px solid #ccc; background: white; }
        .status-tag { font-size: 12px; color: #999; margin-top: 15px; }
        #loading-msg { font-size: 18px; color: var(--primary); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="login-box">
            <h2 style="color: #444;">ğŸ”‘ è«‹è¼¸å…¥ç®¡ç†å¯†ç¢¼</h2>
            <input type="password" id="password-input" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
            <br>
            <button class="tab-btn active" style="background:var(--primary)" onclick="checkPassword()">ç™»å…¥ç³»çµ±</button>
            <p id="login-msg" style="color: red; margin-top: 10px;"></p>
        </div>
    </div>

    <h2 style="color: #444; margin-bottom: 10px;">ğŸŒŸ ç­ç´šç§©åºè‡ªå‹•åŒ–ç®¡ç†ç³»çµ±</h2>
    <div id="loading-msg">æ­£åœ¨è¼‰å…¥ç­ç´šæ¸…å–®...</div>
    <div class="tabs" id="tabs"></div>
    <div id="panels-container"></div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxmg4eK60xWb7Gz1DMA5QhknkcwxFHGi3PtTEiNIOfL-_x_CoDjsJuN3CYQlTYT6y7xIw/exec'; // <--- è²¼ä¸Šä½ çš„ç¶²å€
        let timers = {};
        let scores = {};

        function checkPassword() {
            if (document.getElementById('password-input').value === 'ringoapple') {
                document.getElementById('login-overlay').style.display = 'none';
                loadClasses(); // ç™»å…¥å¾Œæ‰è®€å–ç­ç´š
            } else {
                document.getElementById('login-msg').innerText = 'å¯†ç¢¼éŒ¯èª¤';
            }
        }

        async function loadClasses() {
            try {
                const response = await fetch(SCRIPT_URL);
                const classList = await response.json();
                renderUI(classList);
                document.getElementById('loading-msg').style.display = 'none';
            } catch (e) {
                document.getElementById('loading-msg').innerText = 'è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€èˆ‡è©¦ç®—è¡¨å…§å®¹';
            }
        }

        function renderUI(classList) {
            const tabsContainer = document.getElementById('tabs');
            const panelsContainer = document.getElementById('panels-container');
            
            classList.forEach((cls, index) => {
                scores[cls] = { current: 0 };
                timers[cls] = { totalSeconds: 0, sessionSeconds: 0, interval: null };

                // ç”¢ç”ŸæŒ‰éˆ•
                const btn = document.createElement('button');
                btn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
                btn.innerText = cls;
                btn.onclick = (e) => showClass(cls, e.target);
                tabsContainer.appendChild(btn);

                // ç”¢ç”Ÿé¢æ¿
                const panel = document.createElement('div');
                panel.id = `panel-${cls}`;
                panel.className = `class-panel ${index === 0 ? 'active' : ''}`;
                panel.innerHTML = `
                    <div style="font-size: 1.2rem; color: #888;">ç®¡ç†ä¸­ï¼š${cls} ç­</div>
                    <div class="timer" id="timer-${cls}">00:00</div>
                    <div class="btn-group">
                        <button onclick="startTimer('${cls}')">â–¶ é–‹å§‹è¨ˆæ™‚</button>
                        <button onclick="stopTimer('${cls}')">â¸ æš«åœåŒæ­¥</button>
                        <button onclick="resetTimer('${cls}')">ğŸ”„ é‡è¨­</button>
                    </div>
                    <hr style="margin:20px 0; border:0; border-top:1px solid #eee;">
                    <div class="score-display">æœ¬æ¬¡è©•åˆ†ï¼š<span id="current-${cls}" style="font-weight:bold; color:var(--primary)">0</span></div>
                    <div class="traffic-light">
                        <div class="light red" onclick="updateScore('${cls}', -1)"></div>
                        <div class="light yellow" onclick="updateScore('${cls}', 0)"></div>
                        <div class="light green" onclick="updateScore('${cls}', 1)"></div>
                    </div>
                    <div class="status-tag" id="status-${cls}">å°±ç·’</div>
                `;
                panelsContainer.appendChild(panel);
            });
        }

        function showClass(cls, btn) {
            Object.keys(timers).forEach(c => { if(timers[c].interval) stopTimer(c); });
            document.querySelectorAll('.class-panel').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`panel-${cls}`).classList.add('active');
            btn.classList.add('active');
        }

        function startTimer(cls) {
            if (timers[cls].interval) return;
            timers[cls].interval = setInterval(() => {
                timers[cls].totalSeconds++;
                timers[cls].sessionSeconds++;
                const min = Math.floor(timers[cls].totalSeconds / 60).toString().padStart(2, '0');
                const sec = (timers[cls].totalSeconds % 60).toString().padStart(2, '0');
                document.getElementById(`timer-${cls}`).innerText = `${min}:${sec}`;
            }, 1000);
        }

        function stopTimer(cls) {
            if (!timers[cls].interval) return;
            clearInterval(timers[cls].interval);
            timers[cls].interval = null;
            if (timers[cls].sessionSeconds > 0) {
                syncToCloud(cls, "time", timers[cls].sessionSeconds);
                timers[cls].sessionSeconds = 0;
            }
        }

        function resetTimer(cls) {
            stopTimer(cls);
            timers[cls].totalSeconds = 0;
            document.getElementById(`timer-${cls}`).innerText = "00:00";
        }

        function updateScore(cls, value) {
            scores[cls].current += value;
            document.getElementById(`current-${cls}`).innerText = scores[cls].current;
            syncToCloud(cls, "score", value);
            const panel = document.getElementById(`panel-${cls}`);
            const lights = panel.querySelectorAll('.light');
            lights.forEach(l => l.classList.remove('active'));
            const idx = value === 1 ? 2 : (value === 0 ? 1 : 0);
            lights[idx].classList.add('active');
            setTimeout(() => lights[idx].classList.remove('active'), 600);
        }

        function syncToCloud(cls, type, val) {
            const statusEl = document.getElementById(`status-${cls}`);
            if(statusEl) statusEl.innerText = "åŒæ­¥ä¸­...";
            fetch(SCRIPT_URL, {
                method: "POST",
                mode: 'no-cors',
                body: JSON.stringify({ "class": cls, "type": type, "value": val })
            }).then(() => { if(statusEl) statusEl.innerText = "é›²ç«¯åŒæ­¥æˆåŠŸ"; });
        }
    </script>
</body>
</html>