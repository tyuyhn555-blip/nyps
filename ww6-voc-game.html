<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºæ…§å–®å­—å…¨èƒ½æŒ‘æˆ° - å®Œç¾æœ€çµ‚ç‰ˆ</title>
    <style>
        :root { 
            --c1: #9022E6; --c2: #22E6DE; --c3: #E66722; 
            --c4: #D3E622; --c5: #916046; --c6: #564266; --white: #ffffff;
        }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background-color: var(--c6); display: flex; flex-direction: column; align-items: center; padding: 10px; color: var(--white); min-height: 100vh; margin: 0; }
        .container { display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 800px; }
        .config-section { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 25px; margin-bottom: 15px; width: 100%; text-align: center; border: 2px solid var(--c1); box-sizing: border-box; }
        .btn-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-top: 10px; }
        .menu-btn { padding: 15px; font-size: 18px; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; background: var(--c5); color: white; opacity: 0.7; transition: 0.2s; }
        .active { opacity: 1 !important; transform: scale(1.05); background: var(--c1) !important; border: 2px solid var(--c2) !important; color: var(--c4) !important; }
        .time-select { padding: 10px; font-size: 18px; border-radius: 10px; border: 2px solid var(--c2); background: var(--white); color: var(--c6); font-weight: bold; margin-top: 10px; }
        .input-field { padding: 10px; font-size: 36px; border-radius: 15px; border: 4px solid var(--c2); width: 160px; text-align: center; margin-bottom: 15px; background: white; color: var(--c6); font-weight: bold; }
        .num-pad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 280px; margin: 0 auto 15px; }
        .num-key { background: var(--white); color: var(--c6); border: none; padding: 18px; font-size: 24px; border-radius: 12px; cursor: pointer; box-shadow: 0 4px 0 var(--c5); font-weight: bold; }
        #game-ui { display: none; width: 100%; max-width: 750px; text-align: center; }
        .game-card { background: var(--white); padding: 30px; border-radius: 40px; color: var(--c6); min-height: 520px; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; box-shadow: 0 10px 0 var(--c1); }
        #question { font-size: 70px; margin: 0 0 15px 0; font-weight: 900; color: var(--c1); }
        #progress-bar { width: 100%; height: 20px; background: #ddd; border-radius: 10px; margin-bottom: 20px; overflow: hidden; display: none; }
        #progress-inner { height: 100%; background: linear-gradient(90deg, var(--c1), var(--c2)); width: 100%; transition: linear 100ms; }
        .letter-container { display: flex; gap: 8px; margin: 20px 0; flex-wrap: wrap; justify-content: center; }
        .letter-box { width: 48px; height: 60px; border-bottom: 5px solid var(--c5); font-size: 42px; font-weight: bold; display: flex; align-items: center; justify-content: center; color: var(--c1); }
        .letter-space { width: 35px; border-bottom: none; } 
        .kb-row { display: flex; justify-content: center; gap: 6px; margin-top: 8px; }
        .key { width: 52px; height: 58px; background: var(--c6); color: white; border-radius: 10px; border: none; font-weight: bold; cursor: pointer; box-shadow: 0 4px 0 #333; font-size: 24px; }
        .key-wide { width: 90px; background: var(--c5); font-size: 18px; }
        .key-space { width: 280px; background: var(--c3); margin-top: 10px; }
        .opt-btn { padding: 25px; font-size: 34px; border: none; border-radius: 20px; background: var(--c2); color: var(--c6); cursor: pointer; font-weight: bold; box-shadow: 0 6px 0 var(--c5); width: 100%; margin-bottom: 12px; }
        #timer-text { font-size: 36px; font-weight: bold; color: var(--c4); text-shadow: 2px 2px var(--c1); }
        table { width: 100%; margin-top: 10px; background: white; border-radius: 15px; border-collapse: collapse; overflow: hidden; }
        th { background: var(--c1); color: var(--white); padding: 15px; }
        td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; color: var(--c6); font-weight: bold; }
        .rank-category { color: var(--c2); font-size: 22px; margin-top: 30px; border-bottom: 2px solid var(--c2); display: inline-block; padding: 0 15px; }
    </style>
</head>
<body>

    <div id="setup-menu" class="container">
        <h1 style="font-size:42px; color: var(--c2); text-shadow: 3px 3px var(--c1); margin-bottom:20px;">ğŸš€ å–®å­—ç‹è€…å¤§æŒ‘æˆ°</h1>
        
        <div class="config-section">
            <p style="color:var(--c4); font-weight:bold; font-size: 22px;">1. è€å¸«é»é¸æŒ‘æˆ°å–®å…ƒ (å¯è¤‡é¸)</p>
            <div class="btn-group" style="grid-template-columns: repeat(4, 1fr);">
                <button class="menu-btn" onclick="toggleUnit(1, this)">U1</button>
                <button class="menu-btn" onclick="toggleUnit(2, this)">U2</button>
                <button class="menu-btn" onclick="toggleUnit(3, this)">U3</button>
                <button class="menu-btn" onclick="toggleUnit(4, this)">U4</button>
            </div>
            
            <div class="btn-group" style="margin-top:20px;">
                <button id="type-mole" class="menu-btn" style="background:var(--c3);" onclick="selectType('mole')">ğŸ”µ æ‰“åœ°é¼ æ¨¡å¼</button>
                <button id="type-spell" class="menu-btn active" onclick="selectType('spell')">âŒ¨ï¸ æ‹¼å­—æŒ‘æˆ°</button>
            </div>

            <div id="mode-options" style="margin-top:20px;">
                <div id="mole-modes" class="btn-group" style="display:none;">
                    <button class="menu-btn active" onclick="setSubMode('æ™®é€š', this)">ğŸŸ¢ æ™®é€šé€Ÿåº¦</button>
                    <button class="menu-btn" onclick="setSubMode('ç¥é€Ÿ', this)" style="background:var(--c3);">ğŸ”¥ ç¥é€Ÿåœ°ç„</button>
                </div>
                <div id="spell-modes" class="btn-group" style="grid-template-columns: 1fr;">
                    <button class="menu-btn active" onclick="setSubMode('ç·´ç¿’', this)">ğŸŸ¢ ç·´ç¿’ (ä¸é‡è¤‡é¡Œç›®)</button>
                    <div id="timed-config" style="display:flex; align-items:center; justify-content:center; gap:10px;">
                        <button class="menu-btn" style="flex:1" onclick="setSubMode('è¨ˆæ™‚', this)">â³ è¨ˆæ™‚è³½</button>
                        <select id="time-limit" class="time-select">
                            <option value="60">1 åˆ†é˜</option>
                            <option value="120">2 åˆ†é˜</option>
                            <option value="180">3 åˆ†é˜</option>
                            <option value="240">4 åˆ†é˜</option>
                            <option value="300">5 åˆ†é˜</option>
                        </select>
                    </div>
                    <button class="menu-btn" onclick="setSubMode('ç”Ÿå­˜', this)" style="background:var(--c3);">ğŸ’€ æŒ‘æˆ°è³½ (æ‹¼éŒ¯å³çµæŸ)</button>
                </div>
            </div>
        </div>

        <div class="config-section">
            <input type="text" id="user-no" class="input-field" readonly placeholder="åº§è™Ÿ">
            <div class="num-pad">
                <button class="num-key" onclick="pressNum('1')">1</button>
                <button class="num-key" onclick="pressNum('2')">2</button>
                <button class="num-key" onclick="pressNum('3')">3</button>
                <button class="num-key" onclick="pressNum('4')">4</button>
                <button class="num-key" onclick="pressNum('5')">5</button>
                <button class="num-key" onclick="pressNum('6')">6</button>
                <button class="num-key" onclick="pressNum('7')">7</button>
                <button class="num-key" onclick="pressNum('8')">8</button>
                <button class="num-key" onclick="pressNum('9')">9</button>
                <button class="num-key" style="background:var(--c3); color:white;" onclick="pressNum('C')">C</button>
                <button class="num-key" onclick="pressNum('0')">0</button>
                <button class="num-key" style="background:var(--c3); color:white;" onclick="pressNum('D')">âŒ«</button>
            </div>
            <button class="menu-btn active" style="width:100%; font-size:26px; padding:20px;" onclick="checkStart()">é–‹å§‹æŒ‘æˆ° ğŸš€</button>
            <button class="menu-btn" style="background:none; color:var(--c2); border:2px solid var(--c2); width:100%; margin-top:15px; opacity:1;" onclick="showRanking()">ğŸ† æŸ¥çœ‹æ’è¡Œæ¦œ</button>
        </div>
    </div>

    <div id="game-ui">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="font-size:24px;">ğŸ‘¤ åº§è™Ÿ: <span id="display-no" style="color:var(--c4)">--</span> | ğŸ”¥ åˆ†æ•¸: <span id="score" style="color:var(--white)">0</span></div>
            <div id="timer-text">--</div>
        </div>
        <div class="game-card">
            <div id="progress-bar"><div id="progress-inner"></div></div>
            <h2 id="question">é¡Œç›®</h2>
            <div id="spell-ui" style="display:none; width:100%;">
                <div id="letter-display" class="letter-container"></div>
                <div id="hint-msg" style="height:35px; font-size:20px; margin-bottom:10px; font-weight:bold;"></div>
                <div id="kb-area"></div>
                <button class="menu-btn" style="background:var(--c3); color:white; width:160px; opacity:1; margin-top:20px;" onclick="giveHint()">ğŸ’¡ æç¤º</button>
            </div>
            <div id="mole-ui" style="display:none; width:100%;">
                <div id="options-grid" style="display:grid; gap:15px;"></div>
            </div>
        </div>
        <button onclick="backToMenu()" style="background:none; border:2px solid var(--white); color:var(--white); padding:12px 40px; border-radius:15px; margin-top:25px; cursor:pointer; font-weight:bold;">çµæŸè¿”å›</button>
    </div>

    <div id="rank-ui" style="display:none; width:100%; max-width:650px; text-align:center;">
        <h1 style="font-size:42px; color:var(--c2); text-shadow: 3px 3px var(--c1);">ğŸ† ä»Šæ—¥è‹±é›„æ¦œ</h1>
        <div id="rank-lists-container"></div>
        <button class="menu-btn active" style="width:220px; margin-top:40px; margin-bottom: 40px;" onclick="backToMenu()">è¿”å›é¸å–®</button>
    </div>

    <script>
        // ============================================================
        // âœ¨âœ¨âœ¨ â­ ã€å–®å­—åº«åœ¨æ­¤ï¼è€å¸«è«‹æ”¹é€™è£¡ã€‘ â­ âœ¨âœ¨âœ¨
        // ============================================================
        const wordData = {
            1: [ 
                {en: "bakery", zh: "éºµåŒ…åº—"}, {en: "bank", zh: "éŠ€è¡Œ"}, {en: "bookstore", zh: "æ›¸åº—"},
                {en: "hospital", zh: "é†«é™¢"}, {en: "park", zh: "å…¬åœ’"}, {en: "post office", zh: "éƒµå±€"},
                {en: "restaurant", zh: "é¤å»³"}, {en: "supermarket", zh: "è¶…å¸‚"}
            ],
            2: [
                {en: "bike", zh: "è…³è¸è»Š"}, {en: "bus", zh: "å…¬è»Š"}, {en: "car", zh: "æ±½è»Š"},
                {en: "MRT", zh: "æ·é‹"}, {en: "plane", zh: "é£›æ©Ÿ"}, {en: "scooter", zh: "æ©Ÿè»Š"},
                {en: "taxi", zh: "è¨ˆç¨‹è»Š"}, {en: "train", zh: "ç«è»Š"}
            ],
            3: [
                {en: "dress", zh: "æ´‹è£"}, {en: "skirt", zh: "è£™å­"}, {en: "sweater", zh: "æ¯›è¡£"},
                {en: "T-shirt", zh: "çŸ­è¢–ä¸Šè¡£"}, {en: "pants", zh: "é•·è¤²"}, {en: "shorts", zh: "çŸ­è¤²"},
                {en: "sneakers", zh: "é‹å‹•é‹"}, {en: "socks", zh: "è¥ªå­"}
            ],
            4: [
                {en: "jacket", zh: "å¤¾å…‹"}, {en: "smartphone", zh: "æ™ºæ…§å‹æ‰‹æ©Ÿ"}, {en: "umbrella", zh: "é›¨å‚˜"},
                {en: "watch", zh: "æ‰‹éŒ¶"}, {en: "water bottle", zh: "æ°´å£º"}, {en: "key", zh: "é‘°åŒ™"},
                {en: "glasses", zh: "çœ¼é¡"}
            ]
        };

        // ============================================================
        // æ ¸å¿ƒé‚è¼¯å€
        // ============================================================
        let rankingData = [];
        let selectedUnits = [];
        let mainType = 'spell';
        let subMode = 'ç·´ç¿’';
        let isUpper = false;
        let gamePool = [];
        let score = 0;
        let currentWord = {};
        let userNo = "";
        let spellInput = "";
        let timer = null;
        let practiceQueue = []; // ç”¨æ–¼ç·´ç¿’æ¨¡å¼çš„é¡Œç›®ä½‡åˆ—

        function selectType(t) { 
            mainType = t; 
            document.getElementById('type-mole').classList.toggle('active', t === 'mole');
            document.getElementById('type-spell').classList.toggle('active', t === 'spell');
            document.getElementById('mole-modes').style.display = (t === 'mole' ? 'grid' : 'none');
            document.getElementById('spell-modes').style.display = (t === 'spell' ? 'grid' : 'none');
            subMode = (t === 'mole' ? 'æ™®é€š' : 'ç·´ç¿’');
            document.querySelectorAll('#mode-options .menu-btn').forEach(btn => btn.classList.remove('active'));
            if(t === 'mole') document.querySelector('#mole-modes .menu-btn').classList.add('active');
            else document.querySelector('#spell-modes .menu-btn').classList.add('active');
        }

        function setSubMode(m, b) { 
            subMode = m; 
            document.querySelectorAll('#mode-options .menu-btn').forEach(btn => btn.classList.remove('active'));
            b.classList.add('active');
        }

        function toggleUnit(u, b) { 
            b.classList.toggle('active'); 
            if(b.classList.contains('active')) { if(!selectedUnits.includes(u)) selectedUnits.push(u); } 
            else { selectedUnits = selectedUnits.filter(i => i !== u); } 
        }

        function pressNum(v) { 
            const i = document.getElementById('user-no'); 
            if(v === 'C') i.value = ''; 
            else if(v === 'D') i.value = i.value.slice(0,-1); 
            else if(i.value.length < 3) i.value += v; 
        }

        function checkStart() { 
            userNo = document.getElementById('user-no').value; 
            if(!userNo) return alert("è«‹è¼¸å…¥åº§è™Ÿï¼");
            if(selectedUnits.length === 0) return alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹å–®å…ƒï¼"); 
            gamePool = []; 
            selectedUnits.forEach(u => { if(wordData[u]) gamePool = [...gamePool, ...wordData[u]]; }); 
            if(gamePool.length === 0) return alert("é¸å–çš„å–®å…ƒå…§æ²’æœ‰å–®å­—ï¼");
            
            // ç·´ç¿’æ¨¡å¼å…ˆè¤‡è£½ä¸€ä»½ pool ä¸¦æ´—ç‰Œ
            practiceQueue = [...gamePool];
            shuffle(practiceQueue);
            
            document.getElementById('display-no').innerText = userNo; 
            document.getElementById('setup-menu').style.display = 'none'; 
            document.getElementById('game-ui').style.display = 'block'; 
            startPlay(); 
        }

        function startPlay() { 
            score = 0; 
            document.getElementById('score').innerText = score; 
            document.getElementById('spell-ui').style.display = (mainType === 'spell' ? 'block' : 'none'); 
            document.getElementById('mole-ui').style.display = (mainType === 'mole' ? 'block' : 'none'); 
            document.getElementById('progress-bar').style.display = (mainType === 'mole' ? 'block' : 'none'); 
            if(mainType === 'spell') {
                if(subMode === 'è¨ˆæ™‚') { 
                    let tl = parseInt(document.getElementById('time-limit').value); 
                    timer = setInterval(() => { 
                        tl--; 
                        document.getElementById('timer-text').innerText = Math.floor(tl/60) + ":" + (tl%60).toString().padStart(2,'0'); 
                        if(tl <= 0) endGame("æ™‚é–“åˆ°ï¼"); 
                    }, 1000); 
                } else { 
                    document.getElementById('timer-text').innerText = (subMode === 'ç”Ÿå­˜' ? "ğŸ’€" : "âˆ"); 
                }
                renderKeyboard();
            }
            nextWord(); 
        }

        function nextWord() { 
            if(mainType === 'mole') clearInterval(timer); 

            // ç·´ç¿’æ¨¡å¼é‚è¼¯ï¼šå¾ Queue è£¡é¢æ‹¿é¡Œç›®ï¼Œæ‹¿å®Œå°±çµæŸ
            if(mainType === 'spell' && subMode === 'ç·´ç¿’') {
                if(practiceQueue.length === 0) {
                    endGame("æ­å–œï¼å¦³å·²å®Œæˆé¸å®šå–®å…ƒçš„æ‰€æœ‰å–®å­—æŒ‘æˆ°ï¼ğŸ‰");
                    return;
                }
                currentWord = practiceQueue.shift();
            } else {
                currentWord = gamePool[Math.floor(Math.random() * gamePool.length)]; 
            }

            document.getElementById('question').innerText = currentWord.zh; 
            if(mainType === 'spell') { spellInput = ""; renderBoxes(); } 
            else { startMoleTimer(); renderMoleOptions(); } 
        }

        function renderBoxes() { 
            const container = document.getElementById('letter-display'); 
            container.innerHTML = ''; 
            for(let i = 0; i < currentWord.en.length; i++) { 
                const box = document.createElement('div'); 
                if(currentWord.en[i] === " ") { box.className = 'letter-box letter-space'; box.innerText = " "; } 
                else { box.className = 'letter-box'; box.innerText = spellInput[i] || ""; } 
                container.appendChild(box); 
            } 
        }

        function renderKeyboard() { 
            const area = document.getElementById('kb-area'); area.innerHTML = ''; 
            const rows = [["q","w","e","r","t","y","u","i","o","p"], ["a","s","d","f","g","h","j","k","l"], ["â‡§","z","x","c","v","b","n","m","âŒ«"], ["Space"]]; 
            rows.forEach(row => { 
                const d = document.createElement('div'); d.className = 'kb-row'; 
                row.forEach(k => { 
                    const b = document.createElement('button'); b.className = 'key'; 
                    if(k === "â‡§") { b.innerText = "â‡§"; b.classList.add('key-wide'); b.onclick = () => { isUpper = !isUpper; renderKeyboard(); }; } 
                    else if(k === "âŒ«") { b.innerText = "âŒ«"; b.classList.add('key-wide'); b.onclick = () => { spellInput = spellInput.slice(0,-1); renderBoxes(); }; } 
                    else if(k === "Space") { b.innerText = "Space"; b.classList.add('key-space'); b.onclick = () => handleSpellInput(" "); } 
                    else { let c = isUpper ? k.toUpperCase() : k.toLowerCase(); b.innerText = c; b.onclick = () => handleSpellInput(c); } 
                    d.appendChild(b); 
                }); 
                area.appendChild(d); 
            }); 
        }

        function handleSpellInput(char) { 
            const target = currentWord.en[spellInput.length]; 
            if(char === target) { 
                spellInput += char; 
                if(currentWord.en[spellInput.length] === " ") spellInput += " "; 
                renderBoxes(); 
                if(spellInput.length === currentWord.en.length) { 
                    score += 10; document.getElementById('score').innerText = score; 
                    setTimeout(nextWord, 400); 
                } 
            } else { 
                if(subMode === 'ç”Ÿå­˜') endGame(`æ­£ç¢ºç­”æ¡ˆæ˜¯ "${currentWord.en}"`); 
                else { document.getElementById('hint-msg').innerText = "âŒ ä¸å°å–”ï¼"; setTimeout(() => document.getElementById('hint-msg').innerText = "", 1000); } 
            } 
        }

        function giveHint() { if(spellInput.length < currentWord.en.length) handleSpellInput(currentWord.en[spellInput.length]); }

        function startMoleTimer() { 
            let baseTime = (subMode === 'ç¥é€Ÿ' ? 4.0 : 9.0);
            let ct = baseTime - (score / 35); let full = Math.max(1.1, ct); ct = full; 
            timer = setInterval(() => { 
                ct -= 0.05; document.getElementById('timer-text').innerText = ct.toFixed(2) + "s"; 
                document.getElementById('progress-inner').style.width = (ct / full * 100) + "%"; 
                if(ct <= 0) endGame("æ™‚é–“åˆ°ï¼"); 
            }, 50); 
        }

        function renderMoleOptions() { 
            const grid = document.getElementById('options-grid'); grid.innerHTML = ''; 
            let opts = [currentWord.en]; let others = gamePool.filter(w => w.en !== currentWord.en); 
            shuffle(others); if(others[0]) opts.push(others[0].en); if(others[1]) opts.push(others[1].en); shuffle(opts); 
            opts.forEach(o => { 
                const b = document.createElement('button'); b.className = 'opt-btn'; b.innerText = o; 
                b.onclick = () => { if(o === currentWord.en) { score += 10; document.getElementById('score').innerText = score; nextWord(); } else endGame("é¸éŒ¯å›‰ï¼"); }; 
                grid.appendChild(b); 
            }); 
        }

        function endGame(m) { 
            clearInterval(timer); alert(m + "\næœ€å¾Œå¾—åˆ†: " + score); 
            let modeLabel = (mainType === 'mole' ? 'ğŸ”µ åœ°é¼ ' : 'âŒ¨ï¸ æ‹¼å­—') + " - " + subMode; 
            rankingData.push({no: userNo, score: score, mode: modeLabel}); 
            backToMenu(); 
        }

        function showRanking() { 
            document.getElementById('setup-menu').style.display = 'none'; 
            document.getElementById('rank-ui').style.display = 'block'; 
            const container = document.getElementById('rank-lists-container'); 
            container.innerHTML = ''; 
            const grouped = {};
            rankingData.forEach(r => { if(!grouped[r.mode]) grouped[r.mode] = []; grouped[r.mode].push(r); });
            for(let mode in grouped) {
                const title = document.createElement('div'); title.className = 'rank-category'; title.innerText = mode; container.appendChild(title);
                const table = document.createElement('table'); table.innerHTML = '<tr><th width="20%">åæ¬¡</th><th width="40%">åº§è™Ÿ</th><th width="40%">åˆ†æ•¸</th></tr>';
                grouped[mode].sort((a,b) => b.score - a.score).slice(0, 5).forEach((r, i) => {
                    table.innerHTML += `<tr><td>${i+1}</td><td>${r.no}</td><td style="color:var(--c1)">${r.score}</td></tr>`;
                });
                container.appendChild(table);
            }
            if(rankingData.length === 0) { container.innerHTML = '<p style="margin-top:30px;">ç›®å‰å°šç„¡æŒ‘æˆ°ç´€éŒ„</p>'; }
        }

        function backToMenu() { 
            clearInterval(timer); document.getElementById('game-ui').style.display = 'none'; 
            document.getElementById('rank-ui').style.display = 'none'; document.getElementById('setup-menu').style.display = 'flex'; 
        }

        function shuffle(a) { for(let i = a.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [a[i], a[j]] = [a[j], a[i]]; } }
    </script>
</body>
</html>